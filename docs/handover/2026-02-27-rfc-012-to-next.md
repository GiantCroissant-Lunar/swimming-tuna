# Handover: RFC-012 + RFC Design Reorganization

**Date:** 2026-02-27
**From:** Claude Code session (RFC-012 + design docs)
**Status:** Main branch clean, RFC-013 PR open (#163)

## What was done this session

### 1. RFC-012 Implementation (commits 709d922, 9fd68a3)

Implemented via **agent swarm dogfood** (3 tasks submitted to POST /a2a/tasks):

**Task 1 & 2** (without worktree isolation — runtime was on Production profile):
- Pi adapter definition in `SubscriptionCliRoleExecutor.cs`
- Provider fallback `["pi"] = "pi-agent"` in `RoleModelMapping.cs`
- Default adapter order updated: `["copilot", "cline", "kimi", "kilo", "pi", "local-echo"]`
- 4 unit tests (adapter definition, ordering, parse model spec, resolve fallback)
- Swarm quality: both tasks completed, planner correctly identified code scope

**Task 3** (with worktree isolation — runtime restarted with Dogfood profile):
- Added Pi adapter description comment
- **Validated worktree branch preservation fix (741183e)**
- Branch `swarm/{taskId}` survived task completion
- Gatekeeper reviewed diff on branch, merged to main, deleted branch

### 2. Worktree Fix Validation

- Restarted runtime with `DOTNET_ENVIRONMENT=Dogfood` (enables WorktreeIsolationEnabled)
- Builder ran in worktree, committed to `swarm/task-0cbd22b7` branch
- After task completion: worktree directory removed, **branch preserved**
- Full gatekeeper merge flow confirmed working
- **Known issue found**: builder CLI adapter writes to both worktree AND main workspace
  (cross-task visibility leak still present)

### 3. RFC Reorganization (commit ecf60aa)

Split original RFC-013 (agent-hierarchy-tracing) into three focused RFCs:

| RFC | Name | Scope |
|-----|------|-------|
| RFC-013 | Agent Hierarchy Model | AgentSpan, RunSpan, AgentSpanCollector — shared data model |
| RFC-014 | Run Orchestration & Git Tree | POST /a2a/runs, RunCoordinatorActor, Decomposer role, tree-structured git |
| RFC-015 | Multi-Level Tracing & Enrichment | IOutputEnricher, Langfuse nested spans, Godot hierarchy |

Key design decisions made during brainstorming:
- **Flat spans + tree projection** (not tree-shaped records)
- **Dedicated Decomposer role** (not reusing Planner)
- **Sequential merge gate** (SemaphoreSlim for serialized integration)
- **PR-ready signal** (not automatic PR creation)
- **RunCoordinatorActor as parent** of TaskCoordinators (not peer)

### 4. RFC-016 Design (commit e2589dc)

New RFC for provider quota awareness & usage analytics:
- Capture rate limit headers from API responses
- ProviderQuotaTracker for remaining capacity per provider
- Quota-aware soft dispatch ranking (extend SelectAgent sort)
- Actual tokens preferred over char-based estimation in BudgetEnvelope
- Per-run usage summaries + cross-run trend analytics

### 5. RFC-013 Implementation (by other agent — PR #163)

Another agent implemented RFC-013 on `codex/rfc-013-agent-hierarchy-model`:
- AgentSpan, RunSpan, enums, TokenUsage types in Contracts
- AgentSpanCollector in Runtime
- Wired into AgentFrameworkRoleEngine
- Review fix branch: `codex/rfc-013-reviewfix`
- Test count: 661 → 690 (+29 tests)

## Current state

- **Test count:** 690 (687 pass + 3 skip) on rfc-013 branch
- **Current branch:** main (clean)
- **Open PRs:**
  - PR #163: RFC-013 implementation (`codex/rfc-013-agent-hierarchy-model`) — needs review/merge
  - PR #148: old review fixes (stale)
- **Swarm branches:** 3 unmerged swarm branches from RFC-013 agent work
- **Runtime:** running on Dogfood profile (`DOTNET_ENVIRONMENT=Dogfood`)

## What to do next

### Immediate: Merge RFC-013 PR (#163)
- Review the PR, merge to main
- This unlocks RFC-014, RFC-015, RFC-016

### RFC-014: Run Orchestration & Git Tree (highest value)
- Automates the manual gatekeeper workflow
- `POST /a2a/runs` endpoint, RunCoordinatorActor, Decomposer role
- Tree-structured git: feature branch → task worktrees → merge-back → PR-ready
- Design doc: `docs/plans/rfc-014-run-orchestration-git-tree.md`

### RFC-015: Multi-Level Tracing (independent from RFC-014)
- IOutputEnricher per adapter
- Langfuse nested spans, Godot hierarchy
- Design doc: `docs/plans/rfc-015-multi-level-tracing.md`

### RFC-016: Quota & Analytics (independent from RFC-014/015)
- ProviderQuota from rate limit headers
- Usage summaries and cross-run trends
- Design doc: `docs/plans/rfc-016-provider-quota-usage-analytics.md`

### Implementation order
```
Merge RFC-013 PR (#163)
    ├── RFC-014 (doing the work)     — can be parallelized
    ├── RFC-015 (observing the work) — can be parallelized
    └── RFC-016 (measuring the work) — can be parallelized
```

## Key files changed

```
docs/plans/
├── rfc-013-agent-hierarchy-model.md         # NEW (replaces rfc-013-agent-hierarchy-tracing.md)
├── rfc-014-run-orchestration-git-tree.md    # NEW
├── rfc-015-multi-level-tracing.md           # NEW
├── rfc-016-provider-quota-usage-analytics.md # NEW
├── rfc-013-agent-hierarchy-tracing.md       # DELETED (superseded)
└── 2026-02-26-agent-api-hierarchy-design.md # UPDATED (6 RFCs now)

project/dotnet/src/SwarmAssistant.Runtime/
├── Execution/SubscriptionCliRoleExecutor.cs # Pi adapter + comment
└── Execution/RoleModelMapping.cs            # Pi provider fallback

project/dotnet/tests/SwarmAssistant.Runtime.Tests/
├── SubscriptionCliRoleExecutorTests.cs      # +2 Pi tests
└── RoleModelMappingTests.cs                 # +2 Pi tests
```

## Observations

- Swarm dev flow with worktree isolation works end-to-end
- Runtime MUST be started with `DOTNET_ENVIRONMENT=Dogfood` for worktree isolation
- Builder cross-task workspace leak still present (P1 issue)
- ANTHROPIC_API_KEY not set — hybrid mode falls back to CLI for all roles
- Pi CLI not installed — adapter code is ready but can't probe-test
- SSE stream (`GET /ag-ui/events`) should be used for monitoring instead of polling
