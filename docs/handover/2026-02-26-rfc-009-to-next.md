# Session Handover: RFC-009 Phase 1 → Next

**Date:** 2026-02-26
**From session:** RFC-009 agent skills + Verify GOAP step + review fixes
**Branch:** `feat/rfc-009-agent-skills` (PR #151 open, pending reviewer approval)
**Tests:** 578 passing (baseline was 471)

## What This Session Delivered

### Commit 1: Agent Skills Layer (swarm-produced + gatekeeper fixes)

Dogfooding run — 6 tasks submitted to SwarmAssistant runtime, planner→builder→reviewer pipeline.

- `SkillDefinition` and `MatchedSkill` sealed records with validation
- `SkillFileParser` — YAML frontmatter + markdown body via YamlDotNet
- `SkillIndexBuilder` — recursive SKILL.md discovery with tag/role indexes
- `SkillMatcher` — tag-overlap scoring, role filtering, 4KB budget constraint
- `RolePromptFactory` Layer 5 — `BuildSkillContext` injected between historical and code context
- 5 seed skills from gatekeeper guide patterns (spec-consistency, commit-conventions, error-recovery, security-review, tdd-pattern)
- 85 new tests, 29 gatekeeper fixes for spec-vs-code drift in test files

### Commit 2: Verify GOAP Step (direct implementation)

Motivated by the 29 test failures that passed through the swarm undetected.

- `BuildVerifier` — runs `dotnet build` + `dotnet test` directly (no LLM)
- `Verify` GOAP action — precondition: `BuildExists`, effect: `BuildCompiles`
- `Review` now requires `BuildCompiles=true` — cannot skip verification
- `Rework` resets `BuildCompiles=false` — must re-verify after rework
- `VerifySolutionPath` runtime config option (skip verification when empty)
- `Verifying` state in TaskStatus, TaskLifecycle, AG-UI contracts
- GOAP plan: `Plan → Build → Verify → Review → Finalize`
- 17 new tests

### Commit 3: Resolve PR #151 reviewer comments (this session)

Addressed 12 findings from coderabbitai and gemini-code-assist:

- **SkillFileParser**: Fix BOM regex (remove `^` after `\uFEFF?`), add null check after YAML deserialize
- **BuildVerifier**: Log exception in kill catch, `ParseTestResults` uses `Matches()` for multi-project solutions
- **MatchedSkill**: Move validation into init accessors (prevents `with` bypass)
- **SkillIndexBuilder**: Deterministic file ordering, `GetAllSkills` returns `ReadOnlyDictionary`
- **SkillMatcher**: `break` → `continue` for budget bin-packing
- **TaskCoordinatorActor**: `CancellationTokenSource` for VerifyAsync, cancelled in PostStop
- **error-recovery SKILL.md**: ErrorEnvelope example matches canonical schema
- **Integration test**: Git worktree `.git` file detection
- **RolePromptFactoryTests**: Tightened budget assertion
- 5 new tests (multi-project parse, `with` validation, mixed-size budget packing)

### Commit 4: Fix review-resolve CI agent (this session)

Root cause analysis of run #22421453199 — Copilot agent correctly applied all fixes and generated a 191KB patch, but `safe_outputs` job silently dropped it (`max_patch_size:1024` framework default).

- Add `dotnet` ecosystem to network allowed list (unblocks NuGet restore)
- Add `.github/copilot-setup-steps.yml` (.NET 9 SDK + restore)
- Gitignore `gh-aw` audit logs

## Remaining PR #151 Review Comments (7 new from coderabbitai)

These arrived after commit 3 and need to be addressed in the next session:

1. **`SkillIndexBuilder.cs:37`** (Major) — Handle inaccessible subdirectories during recursive `Directory.EnumerateFiles` (catch `UnauthorizedAccessException`)
2. **`SkillIndexBuilder.cs:71`** (Minor) — Prevent duplicate skill entries per tag when `skill.Tags` contains duplicates
3. **`SkillMatcherTests.cs:437`** (Major) — Test naming or assertion issue in new budget packing test
4. **`SkillMatcherTests.cs:148`** (Minor) — Budget constraint test allows 0 results (tighten `Assert.True(results.Count <= 2)`)
5. **`SkillMatcherTests.cs:304`** (Minor) — Use exact count assertion instead of `<= 3` for maxResults test
6. **`SkillMatcherTests.cs:327`** (Minor) — Empty-title test doesn't isolate behavior (description has non-matching words)
7. **`.github/workflows/review-resolve.md:13`** (Minor) — Network policy comment from coderabbit on the workflow

## Known Issues (carried forward + new)

### P0 — RFC-001 endpoint not functionally integrated (unchanged)

`/a2a/tasks` on per-agent hosts enqueues but nothing consumes outside tests.

**Refs:** `AgentEndpointHost.cs:41`, `SwarmAgentActor.cs:75`
**When to fix:** Standalone fix or RFC-009 Phase 2.

### P1 — AG-UI contract drift (partially addressed)

Added `"verifying"` to AG-UI contracts. Other undeclared events remain.

**Refs:** `ag-ui-contracts.json`
**When to fix:** RFC-008 dashboard layer.

### P1 — No worktree isolation per task (unchanged)

Swarm builders share the same workspace. Concurrent tasks interfere with each other's `HEAD`. Planners see "already implemented" for code written by concurrent builders. `WorkspaceBranchManager` exists but uses branches, not worktrees.

**Impact:** Artifact capture is repo-wide (P1 from RFC-002), concurrent builds can clobber each other.
**Refs:** `WorkspaceBranchManager.cs`, `GitArtifactCollector.cs:38`
**When to fix:** Next session — highest priority infrastructure gap.

**Required changes:**
- `WorkspaceBranchManager.EnsureWorktreeAsync()` — `git worktree add`
- CLI adapter `{{workspace}}` template variable
- `GitArtifactCollector` scoped to worktree path
- Cleanup: `git worktree remove` after task finishes

### P1 — review-resolve `max_patch_size:1024` blocker (NEW)

`gh-aw` framework injects `max_patch_size:1024` (bytes) into `GH_AW_SAFE_OUTPUTS_HANDLER_CONFIG`. Not configurable from `.md` frontmatter. Agent correctly generates patches but `safe_outputs` job silently drops them when they exceed 1024 bytes. Verified via `gh aw audit` on run #22421453199.

**Impact:** Review-resolve workflow cannot create follow-up PRs for multi-file reviews.
**Status:** Network and setup steps fixed. Patch size limit needs upstream `gh-aw` fix.
**Workaround:** Manual review resolution (what we did this session).

### P2 — Swarm unaware of pre-commit hooks (unchanged)

Swarm-produced code had trailing whitespace in 5 files. Builder prompts don't mention pre-commit hook requirements.

**When to fix:** Add to builder role prompt or skill.

### P2 — RFC-003 host allowlist incomplete (unchanged)

Linux/container host filtering not fully enforced.

## Next Steps

### Pre-flight for next session

1. Address 7 remaining PR #151 review comments (list above)
2. Merge PR #151 after review approval
3. Verify 578+ tests pass on main after merge
4. Configure `VerifySolutionPath` in `appsettings.Local.json`
5. Implement worktree isolation (highest priority infra gap)

### Implementation order
RFC-006 → RFC-010 → RFC-007 → RFC-008

## Lessons from This Session

1. **Swarm needs build+test gate** — done: Verify GOAP step. Enable via `VerifySolutionPath`.
2. **Worktree isolation is critical** — concurrent builders sharing workspace causes false "already implemented" and artifact capture pollution.
3. **Scope validation drift** — swarm builders create strict validation but tests use invalid values. Add scope examples to builder/reviewer skills.
4. **Named argument casing matters** — C# record positional parameters are PascalCase. Swarm used camelCase (`description:` vs `Description:`). Add to spec-consistency skill.
5. **Pre-commit hooks catch what swarm doesn't** — trailing whitespace, EOF newlines. Consider running hooks in the Verify step.
6. **`gh-aw` review-resolve has a silent patch size limit** — agent does all the work but safe_outputs drops large patches. Always verify with `gh aw audit <run-id>`.
7. **Always push after commit** — local-only commits are invisible to PR reviewers.

## Files Quick Reference

| Purpose | Path |
|---------|------|
| RFC-009 spec | `docs/plans/rfc-009-agent-skills-knowledge.md` |
| RFC-009 run log | `docs/dogfooding/runs/2026-02-26-rfc-009-agent-skills.md` |
| Skills source | `project/dotnet/src/SwarmAssistant.Runtime/Skills/` |
| BuildVerifier | `project/dotnet/src/SwarmAssistant.Runtime/Execution/BuildVerifier.cs` |
| GOAP actions | `project/dotnet/src/SwarmAssistant.Runtime/Planning/SwarmActions.cs` |
| TaskCoordinator | `project/dotnet/src/SwarmAssistant.Runtime/Actors/TaskCoordinatorActor.cs` |
| Seed skills | `.agent/skills/{spec-consistency,commit-conventions,error-recovery,security-review,tdd-pattern}/` |
| Gatekeeper guide | `docs/dogfooding/gatekeeper-guide.md` |
| Run playbook | `docs/dogfooding/run-playbook.md` |
| Review-resolve workflow | `.github/workflows/review-resolve.md` |
| Copilot setup steps | `.github/copilot-setup-steps.yml` |
