# Session Handover: RFC-009 Phase 1 → Next

**Date:** 2026-02-26
**From session:** RFC-009 agent skills + Verify GOAP step implementation
**Branch:** `feat/rfc-009-agent-skills` (PR pending)
**Tests:** 573 passing (baseline was 471)

## What This Session Delivered

### Commit 1: Agent Skills Layer (swarm-produced + gatekeeper fixes)

Dogfooding run — 6 tasks submitted to SwarmAssistant runtime, planner→builder→reviewer pipeline.

- `SkillDefinition` and `MatchedSkill` sealed records with validation
- `SkillFileParser` — YAML frontmatter + markdown body via YamlDotNet
- `SkillIndexBuilder` — recursive SKILL.md discovery with tag/role indexes
- `SkillMatcher` — tag-overlap scoring, role filtering, 4KB budget constraint
- `RolePromptFactory` Layer 5 — `BuildSkillContext` injected between historical and code context
- 5 seed skills from gatekeeper guide patterns (spec-consistency, commit-conventions, error-recovery, security-review, tdd-pattern)
- 85 new tests, 29 gatekeeper fixes for spec-vs-code drift in test files

### Commit 2: Verify GOAP Step (direct implementation)

Motivated by the 29 test failures that passed through the swarm undetected.

- `BuildVerifier` — runs `dotnet build` + `dotnet test` directly (no LLM)
- `Verify` GOAP action — precondition: `BuildExists`, effect: `BuildCompiles`
- `Review` now requires `BuildCompiles=true` — cannot skip verification
- `Rework` resets `BuildCompiles=false` — must re-verify after rework
- `VerifySolutionPath` runtime config option (skip verification when empty)
- `Verifying` state in TaskStatus, TaskLifecycle, AG-UI contracts
- GOAP plan: `Plan → Build → Verify → Review → Finalize`
- 17 new tests

## Known Issues (carried forward + new)

### P0 — RFC-001 endpoint not functionally integrated (unchanged)

`/a2a/tasks` on per-agent hosts enqueues but nothing consumes outside tests.

**Refs:** `AgentEndpointHost.cs:41`, `SwarmAgentActor.cs:75`
**When to fix:** Standalone fix or RFC-009 Phase 2.

### P1 — AG-UI contract drift (partially addressed)

Added `"verifying"` to AG-UI contracts. Other undeclared events remain.

**Refs:** `ag-ui-contracts.json`
**When to fix:** RFC-008 dashboard layer.

### P1 — No worktree isolation per task (NEW)

Swarm builders share the same workspace. Concurrent tasks interfere with each other's `HEAD`. Planners see "already implemented" for code written by concurrent builders. `WorkspaceBranchManager` exists but uses branches, not worktrees.

**Impact:** Artifact capture is repo-wide (P1 from RFC-002), concurrent builds can clobber each other.
**Refs:** `WorkspaceBranchManager.cs`, `GitArtifactCollector.cs:38`
**When to fix:** Next session — highest priority infrastructure gap.

**Required changes:**
- `WorkspaceBranchManager.EnsureWorktreeAsync()` — `git worktree add`
- CLI adapter `{{workspace}}` template variable
- `GitArtifactCollector` scoped to worktree path
- Cleanup: `git worktree remove` after task finishes

### P2 — Swarm unaware of pre-commit hooks (NEW)

Swarm-produced code had trailing whitespace in 5 files. Builder prompts don't mention pre-commit hook requirements.

**When to fix:** Add to builder role prompt or skill.

### P2 — RFC-003 host allowlist incomplete (unchanged)

Linux/container host filtering not fully enforced.

## Next Steps

### Implementation order
RFC-006 → RFC-010 → RFC-007 → RFC-008

### Before next RFC — infrastructure fixes

1. **Worktree isolation** — implement `git worktree add` per builder task
2. **Enable VerifySolutionPath** — configure in `appsettings.Local.json`:
   ```json
   { "Runtime": { "VerifySolutionPath": "project/dotnet/SwarmAssistant.sln" } }
   ```
3. **Enable WorkspaceBranchEnabled** — once worktree support is ready

### Pre-flight for next session

1. Merge RFC-009 PR (or rebase on main if other PRs merged first)
2. Verify 573 tests pass on main after merge
3. Boot runtime with `VerifySolutionPath` configured
4. Run a small dogfooding task to validate the Verify step works end-to-end

## Lessons from RFC-009 (apply forward)

1. **Swarm needs build+test gate** — done: Verify GOAP step. Enable via `VerifySolutionPath`.
2. **Worktree isolation is critical** — concurrent builders sharing workspace causes false "already implemented" and artifact capture pollution.
3. **Scope validation drift** — swarm builders create strict validation but tests use invalid values. Add scope examples to builder/reviewer skills.
4. **Named argument casing matters** — C# record positional parameters are PascalCase. Swarm used camelCase (`description:` vs `Description:`). Add to spec-consistency skill.
5. **Pre-commit hooks catch what swarm doesn't** — trailing whitespace, EOF newlines. Consider running hooks in the Verify step.

## Files Quick Reference

| Purpose | Path |
|---------|------|
| RFC-009 spec | `docs/plans/rfc-009-agent-skills-knowledge.md` |
| RFC-009 run log | `docs/dogfooding/runs/2026-02-26-rfc-009-agent-skills.md` |
| Skills source | `project/dotnet/src/SwarmAssistant.Runtime/Skills/` |
| BuildVerifier | `project/dotnet/src/SwarmAssistant.Runtime/Execution/BuildVerifier.cs` |
| GOAP actions | `project/dotnet/src/SwarmAssistant.Runtime/Planning/SwarmActions.cs` |
| TaskCoordinator | `project/dotnet/src/SwarmAssistant.Runtime/Actors/TaskCoordinatorActor.cs` |
| Seed skills | `.agent/skills/{spec-consistency,commit-conventions,error-recovery,security-review,tdd-pattern}/` |
| Gatekeeper guide | `docs/dogfooding/gatekeeper-guide.md` |
| Run playbook | `docs/dogfooding/run-playbook.md` |
