# Handover: RFC-006 Langfuse → Cross-Task Coordination

**Date:** 2026-02-26
**From session:** RFC-006 dogfooding + gatekeeper review
**PR:** #157 (`feat/rfc-006-langfuse-replay`) — open, awaiting review

## What Was Done

### PR #155 (Worktree Isolation) — Merged
- Addressed 6 review comments (3 major, 3 minor)
- Squash-merged to main, 583 tests passing

### RFC-006 (Langfuse Replay Engine) — PR #157 Open
- Dogfooded via swarm: 6/6 tasks completed, 0 failures (copilot, worktree isolation enabled)
- Gatekeeper fixed 6 issues:
  1. 32 CS0854 expression tree errors (explicit null for langfuseScoreWriter param)
  2. HttpClient lifetime misuse (store IHttpClientFactory, create per-request)
  3. Missing feature gate (Langfuse DI behind LangfuseTracingEnabled)
  4. Double exception swallowing (transport throws, domain catches)
  5. Role gate for langfuseContext (Planner/Builder/Reviewer only)
  6. Dead ILangfuseSimilarityQuery DI registration removed
- 591 tests passing (8 new)
- Run log: `docs/dogfooding/runs/2026-02-26-rfc-006-langfuse-replay.md`

## Next Session Pre-flight

### 1. Address PR #157 Review Comments
- PR just created, bot reviewers will post comments
- Use receiving-code-review skill for evaluation

### 2. Merge PR #157
- Squash-merge after review approval
- Verify 591+ tests on main

### 3. Implement Cross-Task Coordination (Swarm Enhancement)
User chose **Option B: cross-task context sharing**. Analysis done, three approaches proposed:

**Recommended: Approach C (Hybrid — Sibling Context + Soft Dependencies)**

#### What exists today
- `TaskRegistry` stores all task snapshots with `PlanningOutput`/`BuildOutput`/`ReviewOutput`
- `GlobalBlackboard` supports cross-task stigmergy signals (sparse: success/failure booleans only)
- `RolePromptFactory` has 6 extensible context layers
- **No code path queries sibling task output or injects it into builder prompts**

#### What needs to change

**Part 1: Sibling Context Layer** (~3 files)
- `TaskCoordinatorActor`: before dispatching builder, query `TaskRegistry` for same-run tasks
- Extract completed siblings' plan/build summaries
- `RolePromptFactory`: add 7th context layer for sibling task output
- Independent tasks run in parallel, injecting completed sibling context as available

**Part 2: Soft Dependencies** (~2 files)
- `TaskAssigned` message: add optional `DependsOn` field (list of task IDs)
- `DispatcherActor`: hold dependent tasks until predecessors complete
- Dependent tasks (e.g., "write tests" depends on "implement interfaces") wait for full output

#### Key files to modify
- `TaskCoordinatorActor.cs` — query sibling output before builder dispatch
- `RolePromptFactory.cs` — add sibling context layer (7th)
- `DispatcherActor.cs` — dependency-aware task ordering
- `InternalMessages.cs` / contracts — add `DependsOn` to TaskAssigned
- `/a2a/tasks` endpoint — accept `dependsOn` in task submission

#### Why this matters
- RFC-006 dogfooding: task #4 added optional param to constructor; task #6 (tests) didn't know about it → 32 CS0854 errors
- With sibling context, task #6's builder would see task #4's constructor change and add the explicit null
- With soft dependencies, task #6 would wait for task #4 to complete first

## Known Issues

| Priority | Issue | Status |
|----------|-------|--------|
| P0 | RFC-001 /a2a/tasks per-agent endpoint unused outside tests | Open |
| P1 | CS0854 recurring — builder ignores expression tree warnings | Open (mitigated by cross-task context) |
| P1 | AG-UI contract drift | Partially addressed |
| P1 | gh-aw review-resolve max_patch_size:1024 | Open |
| P2 | RFC-003 host allowlist incomplete (Linux/container) | Open |
| P2 | ILangfuseSimilarityQuery not wired (dead code, source kept) | Deferred |

## Implementation Order
~~RFC-006~~ → Cross-task coordination → RFC-010 → RFC-007 → RFC-008

## Test Count
591 (on feature branch, main is at pre-RFC-006 state until merge)
