# Handover: RFC-011 API-Direct + Swarm Workflow Fixes

**Date:** 2026-02-27
**From:** Claude Code session (RFC-011 + bug fixes)
**Status:** All on main, no open PRs

## What was done this session

### 1. RFC Design Documents (commit 25125b8)

Created three new RFCs:
- `docs/plans/rfc-011-api-direct-activation.md` — API-direct activation & native Anthropic provider
- `docs/plans/rfc-012-pi-adapter.md` — Pi adapter & self-extending agent patterns
- `docs/plans/rfc-013-agent-hierarchy-tracing.md` — Agent hierarchy model & multi-level tracing
- `docs/plans/2026-02-26-agent-api-hierarchy-design.md` — Overview linking all three

Implementation order: RFC-011 → RFC-012 → RFC-013 → RFC-008

### 2. RFC-011 Implementation (commit 02b5cd7)

Implemented via **agent swarm dogfood** (3 tasks submitted to POST /a2a/tasks):

**Swarm-produced:**
- `AnthropicModelProvider.cs` — native Anthropic Messages API client with extended thinking, cache token parsing, dual-constructor pattern (8 tests)
- Anthropic provider registration in `BuildDefaultModelProviders`
- `RuntimeOptions`: `AnthropicApiKeyEnvVar`, `AnthropicBaseUrl`, `AnthropicRequestTimeoutSeconds`
- 2 engine mode tests (api-direct anthropic dispatch, hybrid CLI fallback)

**Gatekeeper fixes:**
- Activated `hybrid` mode in `appsettings.Dogfood.json`
- Added `RoleModelMapping`: Planner → claude-sonnet-4-6 (API), Reviewer → claude-haiku-4-5 (API), Builder → CLI fallback
- Added `gen_ai.request.messages` and `gen_ai.response.content` OTLP span tags

### 3. Bug Fix: Worktree branch preservation (commit 741183e)

**Problem:** `RemoveWorktreeAsync` unconditionally deleted both the worktree directory AND the `swarm/{taskId}` branch. Builder's work was destroyed before gatekeeper could review.

**Root cause:** No merge-back mechanism existed. `PostStop()` ran `git worktree remove --force` + `git branch -D` on every task completion.

**Fix:**
- `CommitWorktreeChangesAsync` — auto-commits uncommitted changes in worktree before removal
- `RemoveWorktreeAsync` — now preserves the branch, only removes worktree directory
- `CleanupBranchAsync` — new method for explicit branch deletion after gatekeeper review
- `RunGitInDirAsync` — extracted helper for git commands with working directory

### 4. Bug Fix: Memvid encoding for skipped-build tasks (commit 469af71)

**Problem:** Tasks where the orchestrator skipped building (GOAP "goal already satisfied") had no `.mv2` file, making them invisible to sibling context queries.

**Root cause:** `TryEncodeTaskMemoryAsync` only called on Builder/Reviewer success. `FinishTask()` didn't encode anything.

**Fix:** `TryEnsureTaskMemoryOnFinishAsync` in `FinishTask()` — checks if `.mv2` exists, if not encodes best available output (build > plan > summary).

## Current state

- **Test count:** 657 (654 pass + 3 skip)
- **All commits on main**, pushed to origin
- **No open PRs**
- **Runtime config:** `appsettings.Dogfood.json` now uses `hybrid` mode with Anthropic API for Planner/Reviewer and kilo/kimi CLI for Builder

## What to do next

### RFC-012: Pi Adapter (small, independent)
- Add Pi as 6th CLI adapter in `SubscriptionCliRoleExecutor.cs`
- Verify Pi CLI is installed (`pi --help`)
- Design doc ready at `docs/plans/rfc-012-pi-adapter.md`
- Can be swarm-dogfooded (1-2 tasks)

### RFC-013: Agent Hierarchy & Tracing (larger)
- `AgentSpan` data model with levels (coordinator → agent → sub-agent)
- `IOutputEnricher` per adapter (kilo JSON, Claude Code JSONL, Cline UI messages)
- Design doc ready at `docs/plans/rfc-013-agent-hierarchy-tracing.md`

### Swarm dev workflow validation
- The worktree fix (741183e) needs dogfood validation — next swarm run should produce preserved `swarm/{taskId}` branches
- Verify gatekeeper can checkout and review the branch before merging
- The memvid fix (469af71) should produce `.mv2` files for all tasks

### RFC-011 dogfood validation
- Hybrid mode is now active in dogfood config
- Next runtime restart will use Anthropic API for Planner/Reviewer roles
- Requires `ANTHROPIC_API_KEY` env var to be set
- If API key is missing, provider is skipped and all roles fall back to CLI

## Key files changed

```
project/dotnet/src/SwarmAssistant.Runtime/
├── Actors/
│   ├── AgentFrameworkRoleEngine.cs          # Anthropic provider registration + OTLP tags
│   └── TaskCoordinatorActor.cs             # TryEnsureTaskMemoryOnFinishAsync
├── Configuration/
│   └── RuntimeOptions.cs                   # Anthropic config properties
├── Execution/
│   ├── AnthropicModelProvider.cs           # NEW: native Anthropic Messages API
│   └── WorkspaceBranchManager.cs           # Branch preservation + auto-commit
└── appsettings.Dogfood.json                # hybrid mode + RoleModelMapping

project/dotnet/tests/SwarmAssistant.Runtime.Tests/
├── AnthropicModelProviderTests.cs          # NEW: 8 tests
├── AgentFrameworkRoleEngineModeTests.cs    # 2 new mode tests
└── WorkspaceBranchManagerTests.cs          # 2 new cleanup tests
```

## Swarm dogfood observations (this session)

- 3/3 tasks completed (all reached `done` status)
- Task 1 (AnthropicModelProvider): full pipeline — orchestrator → planner → builder → reviewer → done
- Task 2 (Registration): planner detected code already existed from task 1 → orchestrator skipped build → done (this triggered the memvid bug discovery)
- Task 3 (Hybrid mode): went through review → rebuild cycle, eventually completed
- Swarm quality: high for task 1, task 3 missed dogfood config changes (gatekeeper fixed)
- Concurrent task ordering: task 1 ran in worktree, task 2's planner could see task 1's output in main dir (accidental cross-task visibility due to worktree isolation not fully working for file writes)
