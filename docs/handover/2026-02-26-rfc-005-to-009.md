# Session Handover: RFC-005 → RFC-009

**Date:** 2026-02-26
**From session:** RFC-005 peer communication implementation + PR review fixes
**Merged PR:** https://github.com/GiantCroissant-Lunar/swimming-tuna/pull/149
**Tests:** 471 passing

## What RFC-005 Delivered

- `PeerMessage`/`PeerMessageAck` contract types with `PeerMessageType` enum
- `GlobalBlackboardKeys` — 5 peer coordination signal keys
- `AgentRegistryActor` — `ResolvePeerAgent` + `ForwardPeerMessage` handlers
- `SwarmAgentActor` — PeerMessage handler with OpenTelemetry tracing
- `POST /a2a/messages` HTTP endpoint with 64KB validation, ErrorEnvelope responses
- AG-UI dashboard events for peer message forwarding
- OpenAPI spec + regenerated C#/TS models
- 17 new tests (471 total)

## Known Issues from Code Review (agent audit)

These were identified by another agent reviewing the full codebase. Prioritize during future RFCs:

### P0 — RFC-001 endpoint not functionally integrated

`/a2a/tasks` on per-agent hosts enqueues into an internal queue and returns 202, but nothing consumes that queue outside tests. This blocks real agent-to-agent delegation.

**Refs:** `AgentEndpointHost.cs:41`, `AgentEndpointHost.cs:73`, `SwarmAgentActor.cs:75`
**When to fix:** During RFC-009 or as a standalone fix — needed for agents to delegate tasks to peers.

### P1 — AG-UI contract drift

Runtime emits many AG-UI events not declared in `ag-ui-contracts.json`:
`agui.dashboard.agents`, `agui.action.acknowledged`, `agui.role.succeeded`, telemetry/graph events.
This breaks deterministic client compatibility.

**Refs:** `AgentRegistryActor.cs:396`, `Program.cs:380`, `TaskCoordinatorActor.cs:477`, `ag-ui-contracts.json:430`
**When to fix:** Next RFC-008 dashboard layer pass.

### P1 — RFC-002 artifact capture not isolated

`GitArtifactCollector` uses repo-wide `git status --porcelain`, so unrelated dirty files get attributed to a task. Weakens artifact lineage and replay fidelity.

**Refs:** `GitArtifactCollector.cs:38`, `TaskCoordinatorActor.cs:1529`
**When to fix:** Consider scoping to task-specific paths during RFC-009 (skills produce artifacts).

### P2 — RFC-003 host allowlist enforcement incomplete

Linux and container host filtering not fully enforced (noted in code).

**Refs:** `LinuxSandboxWrapper.cs:14`, `ContainerNetworkPolicy.cs:7`
**When to fix:** Low priority — sandbox is defense-in-depth, not primary auth.

---

## Next: RFC-009 (Agent Skills & Structural Knowledge)

### Implementation order
RFC-009 → RFC-006 → RFC-010 → RFC-007 → RFC-008

### Pre-flight

1. Ensure on `main` with latest merge:
   ```bash
   git checkout main && git pull
   ```

2. Create branch:
   ```bash
   git checkout -b feat/rfc-009-agent-skills main
   ```

3. Boot runtime and verify health:
   ```bash
   DOTNET_ENVIRONMENT=Local dotnet run \
     --project project/dotnet/src/SwarmAssistant.Runtime \
     --no-launch-profile
   curl http://127.0.0.1:5080/healthz
   ```

### RFC-009 plan location
`docs/plans/rfc-009-agent-skills-knowledge.md` (if drafted) — check existence and review before starting.

---

## Lessons from RFC-005 (apply forward)

1. **Always commit regenerated models** — `task models:generate` outputs C#, TS, JS, and `.d.ts` files. Stage ALL of them. CI will fail on any stale artifact.
2. **Update OpenAPI yaml first, then regenerate** — don't edit schema JSON directly; it's generated from `runtime.v1.yaml`.
3. **Review bot suggestions need verification** — CodeRabbit suggested changing test senders to `TestActor`, but `_agentIdToRef[agentId] = Sender` means the sender IS the agent ref. Blindly applying broke tests.
4. **ErrorEnvelope, not ProblemDetails** — all error responses from our endpoints must use `ErrorEnvelope` (with `error` and `reasonCode` fields) per OpenAPI contract.
5. **Single ack source per message** — never ack from both router and target actor. The target actor is the authoritative ack source.
6. **gh-aw review-resolve workflow** — works for simple reviews, fails on complex multi-file patches. Accept as best-effort; manual fixes are the fallback.

---

## Files Quick Reference

| Purpose | Path |
|---------|------|
| RFC-009 spec | `docs/plans/rfc-009-agent-skills-knowledge.md` |
| RFC-005 run log | `docs/dogfooding/runs/2026-02-25-rfc-005-peer-communication.md` |
| Gatekeeper guide | `docs/dogfooding/gatekeeper-guide.md` |
| Run playbook | `docs/dogfooding/run-playbook.md` |
| Agent registry actor | `project/dotnet/src/SwarmAssistant.Runtime/Actors/AgentRegistryActor.cs` |
| Swarm agent actor | `project/dotnet/src/SwarmAssistant.Runtime/Actors/SwarmAgentActor.cs` |
| OpenAPI spec | `project/docs/openapi/runtime.v1.yaml` |
| AG-UI contracts | `project/docs/ag-ui-contracts.json` |
| Peer messages contract | `project/dotnet/src/SwarmAssistant.Contracts/Messaging/PeerMessages.cs` |
