# Session Handover: RFC-004 → RFC-005

**Date:** 2026-02-25
**From session:** RFC-004 implementation + RFC-009/010 drafting
**Branch:** `feat/rfc-004-agent-registry`
**PR:** https://github.com/GiantCroissant-Lunar/swimming-tuna/pull/145

## Current State

PR #145 has 5 commits and is awaiting review comment resolution:

```
84fff95 docs: draft RFC-009 (skills & knowledge), RFC-010 (provider abstraction), update RFC-006
cb89029 docs(rfc-004): add gatekeeper guide, run log, and enhance reviewer prompt
f455fa1 feat(rfc-004): add heartbeat, HTTP discovery endpoint, and AG-UI events
66d8823 feat(rfc-004): evolve CapabilityRegistryActor into AgentRegistryActor
76da913 feat(rfc-004): add registry contract types and enrich AgentCapabilityAdvertisement
```

454 tests passing. Generated models verified. Pre-commit hooks pass.

---

## Step 1: Address PR #145 Review Comments

Three review bots commented. Here are the actionable items grouped by priority:

### Critical (must fix)

| # | File | Issue | Fix |
|---|------|-------|-----|
| 1 | `AgentRegistryActor.cs:333` | **Dictionary modified during enumeration** in heartbeat check loop. `_health[agentId] = updated` inside `foreach (var (agentId, state) in _health)` throws `InvalidOperationException`. | Collect updates in a separate dict, apply after loop. |
| 2 | `SwarmAgentActor.cs:110` | **Heartbeat schedule not cancelled on actor stop.** `ScheduleTellRepeatedly` is not tied to actor lifecycle — keeps firing after restart/stop. | Store `ICancelable` from `ScheduleTellRepeatedly`, call `Cancel()` in `PostStop()`. |

### Major (should fix)

| # | File | Issue | Fix |
|---|------|-------|-----|
| 3 | `Program.cs:938` | **`catch (TimeoutException)` unreachable.** Akka `Ask` throws `TaskCanceledException` on timeout, not `TimeoutException`. The `when (cancellationToken.IsCancellationRequested)` guard won't match either. | Catch `TaskCanceledException` without the guard, or catch `AskTimeoutException`. |
| 4 | `BudgetEnvelope.cs:15` | **`RemainingFraction` can go negative** on budget overrun (`UsedTokens > TotalTokens`). | Clamp: `Math.Max(0.0, 1.0 - ((double)UsedTokens / TotalTokens))` |
| 5 | `AgentRegistryActor.cs:347` | **Eviction timing hardcoded.** 90s timeout and 30s check interval should derive from configurable heartbeat interval × `MaxMissedHeartbeats`. | Use `_options.AgentHeartbeatIntervalSeconds * MaxMissedHeartbeats`. |
| 6 | `runtime.v1.yaml` + `AgentRegistryEntry.schema.json` | **`provider` marked required but DTO allows null.** `ProviderInfoDto?` is nullable in DTO but required in spec. | Either remove `provider` from `required` and make type `["object", "null"]`, or make DTO non-nullable. |
| 7 | `runtime.v1.yaml:850` | **Missing error response documentation** for the registry endpoint. | Add 401, 503, 504 response schemas. |

### Minor (nice to fix)

| # | File | Issue | Fix |
|---|------|-------|-----|
| 8 | `AgentRegistryActor.cs:346` | Eviction log says "deregistered (graceful)" but eviction is forced. | Change log message to "evicted (missed heartbeats)". |
| 9 | `AgentRegistryActor.cs:378` | `FirstOrDefault()` on `Capabilities` returns zero-value enum for empty list. | Handle empty capabilities case. |
| 10 | `gatekeeper-guide.md:64,99` | Missing language identifier on fenced code blocks (MD040). | Add `bash` or `text` language identifiers. |
| 11 | `local.env:37` | Hardcoded Langfuse password in source control. | Add comment noting it's local-only, or use placeholder. |
| 12 | `AgentRegistryActor.cs:313` | Cheapest cost model logic hardcoded by provider type string. | Extract to helper method for extensibility. |

### Generated model comments (Gemini)

Gemini flagged `Models.g.cs` for nullable mismatches — these are **auto-generated** and
will self-resolve once the OpenAPI schema is corrected (item #6) and `task models:generate`
is re-run. Do NOT manually edit `Models.g.cs`.

### Suggested workflow

```bash
# 1. Fix critical + major items in code
# 2. Re-run tests
dotnet test project/dotnet/SwarmAssistant.sln --verbosity quiet

# 3. Regenerate models after schema fixes
task models:generate
task models:verify

# 4. Commit fixes
git add <fixed files>
git commit -m "fix(rfc-004): address PR #145 review findings"
git push
```

---

## Step 2: Merge PR #145

After review comments are addressed:

```bash
# Verify CI is green, then merge
gh pr merge 145 --squash  # or --merge depending on team preference
git checkout main && git pull
```

---

## Step 3: Start RFC-005 (Peer Communication) via Agent Swarm

### Pre-flight

1. Boot the runtime with Langfuse tracing:
   ```bash
   DOTNET_ENVIRONMENT=Local dotnet run \
     --project project/dotnet/src/SwarmAssistant.Runtime \
     --no-launch-profile
   ```
   Use absolute paths — **never `cd` to subdirectories** (breaks hook system).

2. Verify health:
   ```bash
   curl http://127.0.0.1:5080/healthz
   ```

### Branch

```bash
git checkout -b feat/rfc-005-peer-communication main
```

### Foundation tasks (Claude Code, pre-swarm)

Based on RFC-005, lay the contract types and message structures:

1. **PeerMessage record** — `fromAgentId`, `toAgentId`, `type`, `payload`, `replyTo`
2. **Message types enum** — `TaskRequest`, `TaskResponse`, `HelpRequest`, `Broadcast`
3. **Blackboard signal keys** — `task.available`, `task.claimed`, `task.complete`,
   `artifact.produced`, `help.needed`
4. **POST /a2a/messages endpoint** — receive peer messages, route to target agent actor

### Swarm tasks (submit via POST /a2a/tasks)

After foundation is committed, submit these to the swarm:

| # | Task title | Description |
|---|-----------|-------------|
| 1 | Wire peer message receiving in SwarmAgentActor | Handle incoming PeerMessage, dispatch to appropriate handler based on type |
| 2 | Add peer message sending via registry lookup | Agent queries registry for target, sends HTTP POST to peer endpoint URL |
| 3 | Add blackboard signal subscription for agents | Agents subscribe to specific signal types, react to task.available and help.needed |
| 4 | Add POST /a2a/messages HTTP endpoint | Minimal API endpoint that receives peer messages and routes to agent actor |
| 5 | Add peer communication tracing to Langfuse | Create spans for peer messages with fromAgentId/toAgentId attributes |

### Gatekeeper review

After swarm completes, review using the gatekeeper guide (`docs/dogfooding/gatekeeper-guide.md`):

- Cross-validate any OpenAPI additions against DTO signatures
- Run `task models:verify` after spec changes
- Check Langfuse span attributes match RFC-006 trace structure
- Verify 454+ tests pass

### RFC-008 dashboard layer (Approach C)

After RFC-005 code is merged, add the dashboard layer:

- AG-UI events for peer message activity (`agui.dashboard.messages`)
- Event payload: fromAgentId, toAgentId, message type, timestamp

---

## Key Lessons from RFC-004 (apply to RFC-005)

1. **Split broad tasks** — "implement endpoint" and "write OpenAPI spec" should be
   separate swarm tasks to prevent spec-vs-code drift.
2. **Reviewer prompt is now enhanced** — includes spec-vs-code cross-validation
   checklist (RolePromptFactory.cs, committed in cb89029).
3. **Always run `task models:verify`** after any OpenAPI/schema change — the swarm
   won't do this automatically.
4. **Use absolute paths for all docker/infra commands** — `cd` breaks hooks.
5. **Dictionary mutation during enumeration** — watch for this in actor code that
   iterates state collections.

---

## RFC Roadmap (updated)

```
RFC-004 Agent Registry & Discovery     ← PR #145 (review → merge)
RFC-009 Agent Skills & Knowledge       ← Drafted (docs/plans/rfc-009)
RFC-006 Langfuse Replay + Feedback     ← Updated with feedback loop (docs/plans/rfc-006)
RFC-010 Provider Abstraction           ← Drafted (docs/plans/rfc-010)
RFC-005 Peer Communication             ← NEXT (this handover)
RFC-007 Budget-Aware Lifecycle         ← After RFC-010 (needs token reporting)
RFC-008 Godot Dashboard                ← Interleaved layers after each RFC
```

Implementation order: RFC-005 → RFC-009 → RFC-006 → RFC-010 → RFC-007 → RFC-008

---

## Files Quick Reference

| Purpose | Path |
|---------|------|
| RFC-005 spec | `docs/plans/rfc-005-peer-communication.md` |
| Gatekeeper guide | `docs/dogfooding/gatekeeper-guide.md` |
| Run playbook | `docs/dogfooding/run-playbook.md` |
| RFC-004 run log | `docs/dogfooding/runs/2026-02-25-rfc-004-agent-registry.md` |
| Reviewer prompt | `project/dotnet/src/SwarmAssistant.Runtime/Execution/RolePromptFactory.cs` |
| Agent registry actor | `project/dotnet/src/SwarmAssistant.Runtime/Actors/AgentRegistryActor.cs` |
| CLI adapter executor | `project/dotnet/src/SwarmAssistant.Runtime/Execution/SubscriptionCliRoleExecutor.cs` |
| Runtime options | `project/dotnet/src/SwarmAssistant.Runtime/Configuration/RuntimeOptions.cs` |
| OpenAPI spec | `project/docs/openapi/runtime.v1.yaml` |
