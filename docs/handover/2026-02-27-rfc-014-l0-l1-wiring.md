# Handover: RFC-014 L0/L1 Git Tree Wiring

**Date:** 2026-02-27
**From:** Claude Code session (L0/L1 feature branch wiring)
**Branch:** `codex/rfc-013-hybridfix`
**Test count:** 710 (707 pass + 3 skip)

## What was done this session

### 1. Root cause investigation: P0 builder zero file changes

Identified that `RoleModelMapping` forcing `zai/glm-4.7` on all CLI adapters caused 0% usable output in RFC-014 dogfood. Previous runs without `RoleModelMapping` worked fine. Documented in `docs/findings/2026-02-27-builder-zero-file-changes.md`.

### 2. RFC-014 lifecycle tests (9 new tests)

Created `RunCoordinatorActorTests.cs` with full actor hierarchy using local-echo adapters. Tests cover run-scoped single/multi task lifecycle, duplicate dedup, cross-run routing, RunSpanStatus enum, RunSpan defaults, RunRegistry transitions.

### 3. Wired L0 feature branch creation to L1 task worktrees

**The core fix:** RFC-014 had all the building blocks for tree-structured git but they were disconnected. Three wires connected:

#### Wire 1: DispatcherActor → RunCoordinatorActor (branch config)

`DispatcherActor.HandleRunScopedTaskAssigned` now reads `RunEntry` from `RunRegistry` and passes `title`, `baseBranch`, `branchPrefix` to `RunCoordinatorActor` constructor.

**Before:** `RunCoordinatorActor` created with `title: null`, no branch info.
**After:** Constructor receives `baseBranch` and `branchPrefix` from the run's metadata.

#### Wire 2: RunCoordinatorActor → feature branch (L0 creation)

New `EnsureFeatureBranch()` method called synchronously before the first `TaskCoordinatorActor` is created. Creates `git checkout -b {prefix}/{slug} {baseBranch}`.

**Before:** Feature branch creation depended on `RunConfigured` message that was never sent.
**After:** Branch created eagerly on first task assignment, guaranteed to exist before any worktree.

#### Wire 3: RunCoordinatorActor → TaskCoordinatorActor → worktree (L1 parent)

`TaskCoordinatorActor` now accepts `parentBranch` parameter. When creating worktrees, passes it to `EnsureWorktreeAsync(taskId, parentBranch)` so L1 worktrees fork from the L0 feature branch.

**Before:** `EnsureWorktreeAsync(_taskId)` with no parent → worktree forks from HEAD.
**After:** `EnsureWorktreeAsync(_taskId, _parentBranch)` → worktree forks from feature branch.

### Resulting git tree

```
main                                    ← base branch
 └── feat/rfc-014-pi-adapter            ← L0: created by RunCoordinatorActor.EnsureFeatureBranch()
      ├── swarm/task-001                ← L1: worktree branched from L0
      │    (merges back to L0 on completion)
      ├── swarm/task-002                ← L1: worktree branched from L0
      └── swarm/task-003                ← L1: worktree branched from L0
```

## Files changed

```
project/dotnet/src/SwarmAssistant.Runtime/Actors/DispatcherActor.cs
  - Added RunRegistry field and constructor param
  - HandleRunScopedTaskAssigned: reads RunEntry, passes branch config to RunCoordinatorActor
  - HandleStandaloneTaskAssigned/HandleSpawnSubTask: explicit null for parentBranch (CS0854 fix)

project/dotnet/src/SwarmAssistant.Runtime/Actors/RunCoordinatorActor.cs
  - Added baseBranch/branchPrefix constructor params (stored directly, no longer depends on RunConfigured)
  - Added EnsureFeatureBranch() — synchronous L0 branch creation before first task
  - HandleTaskAssigned: calls EnsureFeatureBranch(), passes _featureBranch to TaskCoordinatorActor
  - Removed async CreateFeatureBranchAsync (replaced by synchronous EnsureFeatureBranch)

project/dotnet/src/SwarmAssistant.Runtime/Actors/TaskCoordinatorActor.cs
  - Added parentBranch field and constructor param
  - Build handler: passes _parentBranch to EnsureWorktreeAsync(taskId, parentBranch)

project/dotnet/src/SwarmAssistant.Runtime/Worker.cs
  - Added RunRegistry injection, passed to DispatcherActor

project/dotnet/tests/SwarmAssistant.Runtime.Tests/RunCoordinatorActorTests.cs
  - Added RunRegistry, passed to DispatcherActor
  - Tests now create runs in RunRegistry before submitting tasks

project/dotnet/tests/SwarmAssistant.Runtime.Tests/TaskCoordinatorLearningContextTests.cs
  - Added explicit null for parentBranch (CS0854 fix)
```

## What remains

### RFC-014
- Task 14: Integration test with real git repo (verify actual branch/worktree creation)
- Task 15: Dogfood validation (blocked by P0 RoleModelMapping issue)
- Decomposer role (tasks 2-3): not yet implemented

### P0: Builder zero file changes
- Root cause documented: `RoleModelMapping` forcing non-native models
- Immediate fix: remove `RoleModelMapping` from dogfood config
- Future: adapter model compatibility matrix

### Ready next
- RFC-015 (tracing) and RFC-016 (analytics): design docs ready, independent of RFC-014
