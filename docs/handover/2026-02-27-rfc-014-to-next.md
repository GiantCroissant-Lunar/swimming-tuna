# Handover: RFC-014 Run Orchestration Implementation

**Date:** 2026-02-27
**From:** Claude Code session (RFC-014 implementation + swarm-dev skill)
**Branch:** `codex/rfc-013-hybridfix`
**Test count:** 701 (698 pass + 3 skip)

## What was done this session

### 1. Created swarm-dev agent skill (commit 5dc271e)

New skill at `.agent/skills/swarm-dev/SKILL.md` codifying the dogfooding workflow:
- Pre-flight (health check, active task check, runtime startup)
- Task decomposition guidelines (granularity, good/bad descriptions)
- Submit commands (POST /runs, POST /a2a/tasks)
- Monitoring (SSE stream, polling, key events, timeout handling)
- Gatekeeper review checklist (CS0854, HttpClient, feature gates, spec drift)
- Merge & commit with attribution
- Run log creation

**Purpose:** Each new session no longer needs to reconstruct the swarm workflow from scattered docs.

### 2. RFC-014 dogfood attempt (run log: docs/dogfooding/runs/2026-02-27-rfc-014-run-orchestration.md)

Submitted 4 tasks to the swarm via POST /a2a/tasks:

| # | Task | Result |
|---|------|--------|
| 1 | MergeTaskBranchAsync + MergeResult | done (but 0 file changes in worktree) |
| 2 | RunCoordinatorActor lifecycle | budget-exhausted → re-submitted → stuck in rework loop |
| 3 | Run endpoints | budget-exhausted → re-submitted → stuck in rework loop |
| 4 | RunCoordinatorActor unit tests | done (but 0 file changes in worktree) |

**Result: 0% usable output.** All 4 tasks produced no file changes despite reaching "done" status.

### 3. RFC-014 gatekeeper implementation (commit 16b196c)

Implemented all remaining RFC-014 tasks directly:

- **MergeResult enum + MergeTaskBranchAsync** — merge-back with conflict detection, abort on conflict, branch cleanup on success
- **CreateBranchFromAsync + PushBranchAsync** — static helpers in WorkspaceBranchManager
- **RunCoordinatorActor lifecycle state machine** — RunSpanStatus tracking (accepted→executing→ready-for-pr→done), TransitionTo method
- **Serialized merge gate** — SemaphoreSlim(1,1) in RunTaskCompleted handler, MergeTaskAsync with lock
- **Feature branch** — slug computation, creation from baseBranch, push on ready-for-pr
- **7 AG-UI run events** — accepted, executing, task-merged, merge-conflict, ready-for-pr, done
- **RunConfigured + RunMarkDone messages** — in InternalMessages.cs
- **Extended POST /runs** — accepts document, baseBranch, branchPrefix; returns featureBranch + status
- **GET /runs** — list all runs
- **POST /runs/{runId}/done** — mark run as done
- **RunRegistry extensions** — ListRuns, MarkDone, UpdateFeatureBranch, extended RunEntry record
- **RunCreateRequest** — extended with Document, BaseBranch, BranchPrefix fields
- **8 new tests** — MergeResult enum, merge BranchNotFound, RunRegistry create/list/done/featureBranch/defaults

## Dogfood findings (P0/P1)

### P0: Builder produces no file changes in worktrees

All 4 tasks completed through the pipeline (planner→builder→reviewer) but the worktree directories had zero `git diff` or `git status` changes. The builder executes via CLI adapter (kimi), the role completes, but no files are modified.

**Hypothesis:** The builder CLI adapter is writing to the main workspace instead of the worktree, or the CLI adapter isn't receiving the worktree path correctly.

**Investigation path:**
1. Check `ExecuteRoleTask.WorkspacePath` — is it passed to the CLI adapter?
2. Check `SubscriptionCliRoleExecutor` — does it use `WorkspacePath` as CWD for the CLI process?
3. Add logging to confirm CWD of the CLI process during builder execution

### P1: Orchestrator rework loop

After re-submitting tasks 2+3 with 2M budget, both entered a builder→orchestrator→rework cycle:
- Builder completes via kimi
- Orchestrator runs, decides "Rework"
- Builder runs again, orchestrator decides "Rework" again
- Loop continues for 50+ ticks without convergence

**Hypothesis:** Orchestrator can't properly evaluate builder output (possibly because there are no file changes to evaluate).

### P1: Budget insufficient for GLM-4.7

Default 500K tokens exhausted after 2/4 tasks. GLM-4.7 via pi/kilo adapters is expensive per invocation.

**Fix:** Set `Runtime__BudgetTotalTokens=2000000` for multi-task runs, or increase default in Dogfood config.

## What remains for RFC-014

| # | Task | Status |
|---|------|--------|
| 1-11 | Core implementation | **Done** (commit 16b196c) |
| 12 | Unit tests: RunCoordinatorActor lifecycle | **Partial** — 8 tests added, full lifecycle/merge-gate serialization tests still needed |
| 13 | Unit tests: WorkspaceBranchManager merge-back | **Partial** — BranchNotFound test added, success/conflict need real git repo or better mocking |
| 14 | Integration test: end-to-end run with 2 tasks | **Not done** |
| 15 | Dogfood validation | **Not done** (blocked by P0 worktree issue) |

## What to do next

### Priority 1: Investigate P0 worktree file issue

This blocks all future dogfooding. Without it, swarm output is useless.

Key files to check:
- `project/dotnet/src/SwarmAssistant.Runtime/Execution/SubscriptionCliRoleExecutor.cs` — how WorkspacePath is used
- `project/dotnet/src/SwarmAssistant.Runtime/Actors/TaskCoordinatorActor.cs` — how WorkspacePath is set on ExecuteRoleTask
- CLI adapter process start — is CWD set to worktree path?

### Priority 2: Complete RFC-014 tests

- RunCoordinatorActor lifecycle tests (full state machine transitions)
- Merge gate serialization test (concurrent completions)
- Integration test with real git repo

### Priority 3: Continue RFC-015 / RFC-016

Both are independent and have design docs ready:
- `docs/plans/rfc-015-multi-level-tracing.md`
- `docs/plans/rfc-016-provider-quota-usage-analytics.md`

## Key files changed

```
.agent/skills/swarm-dev/SKILL.md                                    # NEW — swarm dev workflow skill
AGENTS.md                                                           # Updated skill table
docs/dogfooding/runs/2026-02-27-rfc-014-run-orchestration.md       # NEW — run log
project/dotnet/src/SwarmAssistant.Runtime/A2A/RunCreateRequest.cs   # Extended (document, baseBranch, branchPrefix)
project/dotnet/src/SwarmAssistant.Runtime/Actors/InternalMessages.cs # Added RunConfigured, RunMarkDone
project/dotnet/src/SwarmAssistant.Runtime/Actors/RunCoordinatorActor.cs # Lifecycle, merge gate, feature branch, AG-UI events
project/dotnet/src/SwarmAssistant.Runtime/Execution/WorkspaceBranchManager.cs # MergeResult, MergeTaskBranchAsync, CreateBranchFromAsync, PushBranchAsync
project/dotnet/src/SwarmAssistant.Runtime/Program.cs                # Extended POST /runs, GET /runs, POST /runs/{runId}/done
project/dotnet/src/SwarmAssistant.Runtime/Tasks/RunRegistry.cs      # Extended RunEntry, ListRuns, MarkDone, UpdateFeatureBranch
project/dotnet/tests/SwarmAssistant.Runtime.Tests/RunEndpointsTests.cs # +6 RunRegistry tests
project/dotnet/tests/SwarmAssistant.Runtime.Tests/WorkspaceBranchManagerTests.cs # +2 merge tests
```
