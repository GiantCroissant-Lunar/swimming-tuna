# Dogfooding Run Log

- **Date:** 2026-02-25
- **Operator:** Claude Code (gatekeeper) + SwarmAssistant runtime
- **Run goal:** Implement RFC-004 Agent Registry & Discovery using the dogfooding approach
- **Runtime profile:** Local
- **Adapter order:** copilot → cline → kimi → local-echo
- **ArcadeDB enabled:** yes
- **Langfuse tracing enabled:** yes
- **Fault injection:** SimulateBuilderFailure=false, SimulateReviewerFailure=false

## Foundation (pre-swarm, Claude Code)

Two commits laid the groundwork before submitting tasks to the swarm:

1. `76da913` — Contract types: ProviderInfo, BudgetEnvelope, CircuitBreakerState,
   AgentRegistryMessages, enriched AgentCapabilityAdvertisement
2. `66d8823` — Evolved CapabilityRegistryActor → AgentRegistryActor with heartbeat
   tracking, eviction, lifecycle signals, AG-UI dashboard events, QueryAgents

## Tasks Submitted

| # | taskId | Title | Final state | Notes |
|---|--------|-------|-------------|-------|
| 1 | (swarm-assigned) | Wire heartbeat timer in SwarmAgentActor and send rich advertisements | done | Copilot CLI adapter |
| 2 | (swarm-assigned) | Add GET /a2a/registry/agents HTTP endpoint with capability/prefer filtering | done | Copilot CLI adapter |
| 3 | (swarm-assigned) | Add AgentRegistryActorTests for heartbeat-updates-health-state | done | Copilot CLI adapter |

All 3 tasks completed through the full planner → builder → reviewer pipeline.

## Observations

- Copilot CLI was the first adapter in the fallback chain and handled all 3 tasks
- The swarm correctly identified files to modify (SwarmAgentActor, Program.cs, Worker.cs)
- RuntimeActorRegistry DI bridge was a good architectural decision by the swarm —
  cleanly separates ASP.NET minimal API from Akka.NET actor system
- Total: 454 tests passing (1 new test added by swarm, 8 by foundation)

## Replay Findings

### Task 1 — Heartbeat + Rich Advertisement
- Quality: Good. Correctly populated ProviderInfo from agent options, scheduled
  heartbeat timer via Akka scheduler, chose BudgetType.Unlimited default.

### Task 2 — HTTP Discovery Endpoint
- Quality: Mostly good. Created proper DTOs, added input validation, error handling.
- **Issue 1 (Important):** Status field set to `entry.CircuitBreakerState.ToString()`,
  duplicating the circuitBreakerState field. Should derive semantic status.
- **Issue 2 (Important):** OpenAPI `prefer` param description said "lowest-cost",
  "highest-capacity" but code accepts "cheapest", "least-loaded".
- **Issue 3 (Important):** JSON schema and OpenAPI spec declared lastHeartbeat,
  consecutiveFailures, circuitBreakerState as nullable, but DTO has them non-nullable.

### Task 3 — Heartbeat Test
- Quality: Good. Clean test verifying heartbeat updates health state.

## Gatekeeper Fixes Applied

| Fix | Files | Severity |
|-----|-------|----------|
| Status derives "active"/"unhealthy" from ConsecutiveFailures | Program.cs | Important |
| OpenAPI prefer description matches code values | runtime.v1.yaml | Important |
| Schema nullability: 3 fields changed to non-nullable + required | AgentRegistryEntry.schema.json, runtime.v1.yaml | Important |
| Regenerated C# and TypeScript models | Models.g.cs, models.g.ts, models.g.d.ts | Required |

## Retro

### What went well

- Dogfooding pipeline works end-to-end: submit tasks → swarm processes → gatekeeper reviews
- Foundation + swarm split is effective: lay contract types and actor evolution manually,
  let the swarm handle wiring, endpoints, and tests
- All code compiled and tests passed before gatekeeper intervention
- Copilot CLI adapter reliably executed all tasks

### What did not go well

- Spec-vs-code drift: 3 out of 3 important issues were documentation/schema not matching code
- Reviewer agent did not catch the mismatches — it approved the work
- Generated models not regenerated by swarm (gatekeeper had to run `task models:generate`)
- CWD change in earlier session broke hook system (lesson: always use absolute paths)

### Action items

| Item | Owner | Status |
|------|-------|--------|
| Update reviewer prompt with spec-vs-code cross-validation checklist | Claude Code | Done (RolePromptFactory.cs) |
| Create gatekeeper guide documenting review patterns | Claude Code | Done (docs/dogfooding/gatekeeper-guide.md) |
| Consider adding `task models:verify` as post-build step in pipeline | Future RFC | Open |
| Split broad tasks (endpoint + spec) into separate submissions | Process | Open |
