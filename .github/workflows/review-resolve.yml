name: Review Comment Resolver

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: read
  issues: write

concurrency:
  group: review-resolve-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  resolve-review-comments:
    # Only trigger for bot reviewers requesting changes
    if: >-
      github.event.review.state == 'changes_requested'
      && (
        github.event.review.user.type == 'Bot'
        || contains(fromJSON('["github-actions[bot]","copilot[bot]"]'), github.event.review.user.login)
      )
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing fix issue
        id: dedup
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: issues } = await github.rest.issues.listForRepo({
              ...context.repo,
              labels: 'review-fix',
              state: 'open',
            });
            const existing = issues.find(i =>
              i.title.includes(`PR #${prNumber}`)
            );
            if (existing) {
              core.info(`Fix issue already exists: #${existing.number}`);
              core.setOutput('exists', 'true');
            } else {
              core.setOutput('exists', 'false');
            }

      - name: Collect review comments
        if: steps.dedup.outputs.exists == 'false'
        id: collect
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const { data: comments } = await github.rest.pulls.listReviewComments({
              ...context.repo,
              pull_number: prNumber,
            });

            // Filter to bot-authored comments only
            const botComments = comments.filter(c =>
              c.user.type === 'Bot'
              || ['github-actions[bot]', 'copilot[bot]'].includes(c.user.login)
            );

            if (botComments.length === 0) {
              core.info('No bot review comments found');
              core.setOutput('has_comments', 'false');
              return;
            }

            // Group by file path
            const grouped = {};
            for (const c of botComments) {
              if (!grouped[c.path]) grouped[c.path] = [];
              grouped[c.path].push({
                line: c.line || c.original_line,
                body: c.body,
                diff_hunk: c.diff_hunk,
              });
            }

            core.setOutput('has_comments', 'true');
            core.setOutput('comments_json', JSON.stringify(grouped));
            core.setOutput('comment_count', String(botComments.length));

      - name: Create issue for Copilot Coding Agent
        if: steps.dedup.outputs.exists == 'false' && steps.collect.outputs.has_comments == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const comments = JSON.parse(process.env.COMMENTS_JSON);
            const count = parseInt(process.env.COMMENT_COUNT, 10);

            // Build structured issue body
            let body = `## Review Comment Resolution\n\n`;
            body += `**Source PR:** #${pr.number} (${pr.title})\n`;
            body += `**Branch:** \`${pr.head.ref}\`\n`;
            body += `**Base:** \`${pr.base.ref}\`\n`;
            body += `**Comments to resolve:** ${count}\n\n`;
            body += `---\n\n`;

            for (const [file, fileComments] of Object.entries(comments)) {
              body += `### \`${file}\`\n\n`;
              for (const c of fileComments) {
                body += `**Line ${c.line}:**\n`;
                body += `> ${c.body.replace(/\n/g, '\n> ')}\n\n`;
                if (c.diff_hunk) {
                  body += `<details><summary>Diff context</summary>\n\n`;
                  body += `\`\`\`diff\n${c.diff_hunk}\n\`\`\`\n`;
                  body += `</details>\n\n`;
                }
              }
            }

            body += `---\n\n`;
            body += `Create a follow-up PR branching from \`${pr.head.ref}\` that targets \`${pr.base.ref}\`.\n`;
            body += `Resolve each review comment listed above and reference this issue in the PR description.\n\n`;
            body += `_Automated by review-resolve workflow run [#${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})_\n`;

            const { data: issue } = await github.rest.issues.create({
              ...context.repo,
              title: `fix(review): resolve ${count} review comment${count === 1 ? '' : 's'} from PR #${pr.number}`,
              body,
              labels: ['review-fix', 'automated'],
              assignees: ['copilot-swe-agent'],
            });

            // Post tracking comment on the original PR
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: pr.number,
              body: [
                `Review comments have been forwarded to Copilot Coding Agent for resolution.`,
                ``,
                `Tracking issue: #${issue.number}`,
              ].join('\n'),
            });

            core.info(`Created issue #${issue.number} assigned to copilot-swe-agent`);
        env:
          COMMENTS_JSON: ${{ steps.collect.outputs.comments_json }}
          COMMENT_COUNT: ${{ steps.collect.outputs.comment_count }}
